#!/bin/bash
# Verify directory coverage between clone and analysis.json

MOUNT_BASE="/storage/tmp/zfs-fd-analysis"
ANALYSIS_JSON="/var/lib/zfs-fd/2025-07-18T12:00:11-07:00/analysis.json"

echo "=== ZFS-FD Directory Coverage Verification ==="
echo "Mount base: $MOUNT_BASE"
echo "Analysis file: $ANALYSIS_JSON"
echo

# Count total directories at each depth
echo "Directory counts by depth in clone:"
for depth in 1 2 3 4; do
    count=$(find "$MOUNT_BASE" -mindepth $depth -maxdepth $depth -type d 2>/dev/null | wc -l)
    echo "  Depth $depth: $count directories"
done
echo

# Extract and count directories from analysis
total_in_analysis=$(jq -r '.directories | length' "$ANALYSIS_JSON")
echo "Total directories in analysis.json: $total_in_analysis"
echo

# Find directories with no direct files
echo "Checking for empty directories (no direct files)..."
find "$MOUNT_BASE" -maxdepth 3 -type d -exec sh -c '
    dir="$1"
    if [ $(find "$dir" -maxdepth 1 -type f 2>/dev/null | wc -l) -eq 0 ]; then
        # Strip mount base for display
        rel_dir=${dir#/storage/tmp/zfs-fd-analysis/}
        if [ "$rel_dir" != "" ]; then
            echo "$rel_dir"
        fi
    fi
' _ {} \; | head -20

echo
echo "Summary:"
echo "- Directories missing from analysis.json are those with no direct files"
echo "- The analysis.json contains directories at all depths (not limited to depth 3)"
echo "- All directories with files appear to be properly captured"
